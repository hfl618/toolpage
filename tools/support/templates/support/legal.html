{% extends "support/layout.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
{% with page_id='index' %}{% include 'support/seo_tags.html' %}{% endwith %}
{% endblock %}

{% block extra_css %}
<style>
    .legal-content {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 64px;
        border-radius: 32px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.05);
        border: 1px solid rgba(0,0,0,0.02);
    }
    .legal-body h1 { font-size: 32px; font-weight: 800; margin-bottom: 24px; color: #0f172a; }
    .legal-body h2 { font-size: 20px; font-weight: 800; margin: 32px 0 16px; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
    .legal-body p { font-size: 15px; line-height: 1.8; color: #475569; margin-bottom: 16px; }
    .legal-body ul { margin-bottom: 24px; padding-left: 20px; }
    .legal-body li { font-size: 15px; line-height: 1.8; color: #475569; margin-bottom: 8px; list-style-type: disc; }
    .legal-body strong { color: #0f172a; font-weight: 700; }
    .legal-body a { color: #0071e3; text-decoration: none; font-weight: 600; }
    .legal-body a:hover { text-decoration: underline; }
    
    @media (max-width: 768px) {
        .legal-content { padding: 32px 24px; border-radius: 24px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="legal-content">
    <div id="legal-body" class="legal-body">
        <div class="flex justify-center py-10">
            <div class="spinner-border text-blue-600"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function loadLegalDoc() {
        const docType = "{{ doc_type }}";
        const lang = localStorage.getItem('lang') || 'zh';
        const body = document.getElementById('legal-body');
        
        // Update document title based on language
        const titles = {
            'privacy': { 'zh': '隐私政策', 'en': 'Privacy Policy' },
            'terms': { 'zh': '服务条款', 'en': 'Terms of Service' }
        };
        if(titles[docType]) {
            document.title = titles[docType][lang] + " | 618002.xyz";
        }
        
        try {
            const r = await fetch(`/support/help_doc?lang=${lang}&path=/support/${docType}`);
            const d = await r.json();
            
            if(d.success && d.content) {
                body.innerHTML = parseMarkdown(d.content);
            } else {
                body.innerHTML = `<p class="text-center text-slate-400">${lang === 'zh' ? '未找到相关文档。' : 'Document not found.'}</p>`;
            }
        } catch(e) {
            body.innerHTML = `<p class="text-center text-red-500">${lang === 'zh' ? '加载文档出错。' : 'Error loading document.'}</p>`;
        }
    }

    function parseMarkdown(md) {
        if (!md) return "";
        let lines = md.split(/\r?\n/);
        let html = "";
        let inList = false;

        lines.forEach(line => {
            let l = line.trim();
            if (!l) {
                if (inList) { html += "</ul>"; inList = false; }
                return;
            }

            // 标题
            if (l.startsWith("# ")) {
                if (inList) { html += "</ul>"; inList = false; }
                html += `<h1>${l.substring(2)}</h1>`;
            } else if (l.startsWith("## ")) {
                if (inList) { html += "</ul>"; inList = false; }
                html += `<h2>${l.substring(3)}</h2>`;
            } 
            // 列表
            else if (l.startsWith("- ")) {
                if (!inList) { html += "<ul>"; inList = true; }
                html += `<li>${parseInline(l.substring(2))}</li>`;
            } 
            // 普通段落
            else {
                if (inList) { html += "</ul>"; inList = false; }
                html += `<p>${parseInline(l)}</p>`;
            }
        });

        if (inList) html += "</ul>";
        return html;
    }

    function parseInline(txt) {
        return txt
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
    }

    window.addEventListener('DOMContentLoaded', loadLegalDoc);
    
    // Global language change hook
    window.onLangChange = function() {
        loadLegalDoc();
    };
</script>
{% with page_id='index' %}{% include 'support/seo_hidden.html' %}{% endwith %}
{% endblock %}
