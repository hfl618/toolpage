{% extends "support/layout.html" %}

{% block title %}云端串口调试 Pro{% endblock %}
{% block app_icon %}S{% endblock %}
{% block app_name %}<span class="i18n" data-zh="串口调试" data-en="Serial Studio">串口调试</span>{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        --mac-bg: #f5f5f7;
        --mac-dark: #1e1e1e;
        --accent: #007aff;
        --success: #34c759;
        --danger: #ff3b30;
        --dev-font: 'JetBrains Mono', 'Fira Code', monospace;
    }

    body { background-color: var(--mac-bg); overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; }
    
    /* 强力覆盖全局边距，对接导航栏 */
    body main.max-w-7xl { 
        position: fixed !important;
        top: 80px !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        max-width: none !important;
        width: 100vw !important;
        margin: 0 !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: row !important;
        background: var(--mac-bg) !important;
        z-index: 50;
    }

    /* 栏 1：监控区 */
    .monitor-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 16px; min-width: 400px; overflow: hidden; }

    /* 栏 2+3：控制区总容器 */
    .controls-area { width: 520px; display: flex; flex-direction: row; background: white; border-left: 1px solid #e2e8f0; flex-shrink: 0; height: 100%; }

    /* 内部子列 */
    .control-column { flex: 1; display: flex; flex-direction: column; gap: 20px; padding: 20px; overflow-y: auto; border-right: 1px solid #f1f5f9; }
    .control-column:last-child { border-right: none; }

    /* 拖拽条 */
    .resizer { width: 10px; cursor: col-resize; background: transparent; flex-shrink: 0; z-index: 100; margin-left: -5px; }
    .resizer:hover, .resizer.resizing { background: var(--accent); opacity: 0.2; }

    /* 通用卡片 */
    .card-pro { background: white; border: 1px solid #e2e8f0; border-radius: 1.5rem; overflow: hidden; display: flex; flex-direction: column; }
    .card-header-pro { padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #f1f5f9; }
    .card-title-pro { font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin: 0; }

    /* 终端输出 */
    .terminal-box { flex: 1; background: white; padding: 20px; font-family: var(--dev-font); font-size: 14px; overflow-y: auto; line-height: 1.6; }
    .log-entry { border-bottom: 1px solid #f8fafc; padding: 6px 0; display: flex; gap: 10px; align-items: flex-start; }
    .timestamp { color: #94a3b8; font-weight: 600; min-width: 85px; font-size: 11px; cursor: pointer; }
    .badge-sim { background: #fef3c7; color: #b45309; padding: 1px 5px; border-radius: 4px; font-size: 9px; font-weight: 800; margin-right: 4px; }

    /* 颜色标识 */
    .tx-msg { color: var(--accent); font-weight: 700; }
    .rx-hex { color: #8b5cf6; font-weight: 700; }
    .auto-msg { color: #f59e0b; font-weight: 700; }
    .sys-msg { color: #64748b; font-style: italic; font-weight: 600; }

    /* 下拉框与输入 */
    .min-select { border: none !important; background: transparent !important; font-size: 10px !important; font-weight: 900 !important; color: #64748b !important; cursor: pointer; outline: none; text-transform: uppercase; }
    .min-select:hover { color: var(--accent) !important; }
    
    .input-pro { background: #f1f5f9; border: 2px solid transparent; border-radius: 12px; padding: 10px 16px; font-weight: 600; font-size: 13px; transition: 0.2s; width: 100%; color: #1e293b; }
    .input-pro:focus { background: white; border-color: var(--accent); outline: none; }

    .btn-pro { padding: 10px 20px; border-radius: 12px; font-weight: 800; font-size: 13px; border: none; cursor: pointer; transition: 0.2s; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-pro-dark { background: #0f172a; color: white; }
    .btn-pro-dark:hover { background: #1e293b; transform: translateY(-1px); }
    .btn-connect-active { background: var(--danger) !important; }

    /* 宏指令按钮 */
    .btn-macro-item { 
        background: #f8fafc; 
        border: 1px solid #e2e8f0; 
        border-radius: 12px; 
        padding: 12px 16px; 
        font-size: 13px; 
        font-weight: 700; 
        color: #1e293b; 
        position: relative; 
        width: 100%; 
        text-align: left; 
        transition: 0.2s;
    }
    .btn-macro-item:hover { background: #f1f5f9; border-color: var(--accent); }
    .btn-macro-item.polling { border-color: var(--accent); background: #eff6ff; animation: pulse-polling 2s infinite; }
    @keyframes pulse-polling { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    /* 宏指令操作按钮 - 内置化 */
    .macro-actions { 
        position: absolute; 
        right: 8px; 
        top: 50%; 
        transform: translateY(-50%); 
        display: none; 
        gap: 4px; 
        z-index: 10; 
    }
    .group:hover .macro-actions { display: flex; }
    .action-circle { 
        width: 24px; 
        height: 24px; 
        border-radius: 8px; 
        background: rgba(255, 255, 255, 0.9); 
        backdrop-filter: blur(4px);
        border: 1px solid rgba(0,0,0,0.05); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        cursor: pointer; 
        color: #64748b; 
        font-size: 12px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        transition: all 0.2s;
    }
    .action-circle:hover { background: white; color: var(--accent); transform: scale(1.1); }
    .action-circle.delete:hover { color: var(--danger); }

    /* 动态列表项通用 */
    .dynamic-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; position: relative; margin-bottom: 8px; }

    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; }
    .status-dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); }

    .check-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
    .hl-error { background: #fee2e2; color: #dc2626; padding: 1px 4px; border-radius: 3px; }
    .hl-success { background: #dcfce7; color: #16a34a; padding: 1px 4px; border-radius: 3px; }
    .hl-info { background: #e0f2fe; color: #0284c7; padding: 1px 4px; border-radius: 3px; }
    .hl-warn { background: #ffedd5; color: #d97706; padding: 1px 4px; border-radius: 3px; }
    .hl-extra { background: #f3e8ff; color: #9333ea; padding: 1px 4px; border-radius: 3px; }

    main > div.mt-12 { display: none !important; }
</style>
{% endblock %}

{% block content %}
    <!-- 监控区 -->
    <section class="monitor-area" id="monitorCol">
        <div class="card-pro shadow-sm flex-1">
            <div class="card-header-pro flex flex-column gap-3">
                <!-- 行 1：搜索 -->
                <div class="flex justify-between items-center gap-4">
                    <div class="flex items-center bg-slate-200/50 rounded-xl px-4 py-1.5 flex-1 shadow-inner">
                        <i class="ri-search-line text-slate-400 mr-2"></i>
                        <input type="text" id="logSearch" class="border-0 bg-transparent outline-none text-sm font-bold w-full i18n-ph" data-zh-ph="搜索关键词过滤日志..." data-en-ph="Search logs..." placeholder="搜索关键词过滤日志..." oninput="filterLogs()">
                    </div>
                    <div class="bg-white border border-slate-200 px-4 py-1.5 rounded-xl shadow-sm text-[10px] font-black text-slate-400 uppercase">
                        RX: <span id="rxCounter" class="text-blue-600 font-mono text-xs">0</span> B
                    </div>
                </div>
                <!-- 行 2：视图控制 -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-1 bg-slate-100/80 px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm">
                        <select id="dataViewMode" class="min-select !text-blue-600" onchange="resetTerminal()">
                            <option value="text">VIEW: TEXT</option><option value="hex">VIEW: HEX</option>
                            <option value="rgb">VIEW: RGB</option><option value="dec">VIEW: DEC</option>
                        </select>
                        <div class="w-px h-3 bg-slate-300 mx-1"></div>
                        <select id="textEncoding" class="min-select" onchange="resetTerminal()">
                            <option value="utf-8">UTF-8</option><option value="gbk">GBK</option>
                        </select>
                        <div class="w-px h-3 bg-slate-300 mx-1"></div>
                        <select id="tsMode" class="min-select" onchange="toggleTimeMode(this.value)">
                            <option value="abs" class="i18n" data-zh="绝对时间" data-en="ABS TIME">ABS TIME</option>
                            <option value="delta" class="i18n" data-zh="相对增量" data-en="DELTA (Δ)">DELTA (Δ)</option>
                        </select>
                    </div>
                    <div class="flex gap-5 items-center">
                        <label class="check-label"><input type="checkbox" id="rxHex"> HEX</label>
                        <label class="check-label"><input type="checkbox" id="autoScroll" checked> <span class="i18n" data-zh="滚动" data-en="SCROLL">滚动</span></label>
                        <label class="check-label"><input type="checkbox" id="showChart" onchange="toggleChart()"> <span class="i18n" data-zh="波形" data-en="WAVE">波形</span></label>
                        <button onclick="clearLog()" class="text-[10px] font-black text-slate-300 hover:text-red-500 transition-colors ml-4 uppercase i18n" data-zh="清空" data-en="Clear">Clear</button>
                    </div>
                </div>
            </div>
            <div id="terminal" class="terminal-box"></div>
            <div id="chartContainer" class="hidden border-t border-slate-100 p-4 bg-slate-50/50">
                <div id="chartLegend" class="flex gap-3 mb-2"></div>
                <canvas id="waveformCanvas" class="w-full h-40"></canvas>
            </div>
        </div>

        <div class="card-pro py-2 px-4 shadow-sm">
            <div class="flex gap-4 items-center">
                <input type="text" id="txInput" class="input-pro flex-1 font-mono i18n-ph !py-1.5" data-zh-ph="发送指令..." data-en-ph="Type command..." placeholder="发送指令..." onkeydown="if(event.key==='Enter') sendFromInput()">
                <select id="lineEnding" class="input-pro !w-auto !py-1.5">
                    <option value="\r\n">CRLF</option><option value="\n">LF</option><option value="">NONE</option>
                </select>
                <label class="check-label border-l pl-4 border-slate-100"><input type="checkbox" id="clearAfterSend" checked> <span class="i18n" data-zh="清空" data-en="Clear">清空</span></label>
                <button class="btn-pro btn-pro-dark px-10 shadow-lg i18n !py-1.5" data-zh="发送数据" data-en="Send Data" onclick="sendFromInput()">发送数据</button>
            </div>
        </div>

        <!-- 极致紧凑的广告位 -->
        <div class="mt-1">
            {% with placement='footer_grid', page_id='serial', limit=3 %}
                {% include 'support/unified_footer.html' %}
            {% endwith %}
        </div>
    </section>

    <div id="resizer" class="resizer"></div>

    <!-- 控制区总成 -->
    <section class="controls-area" id="controlsArea">
        <div class="control-column">
            <div class="card-pro mb-4">
                <div class="card-header-pro flex justify-between items-center"><span class="card-title-pro i18n" data-zh="端口设置" data-en="Port Settings">Port Settings</span><div id="statusDot" class="status-dot"></div></div>
                <div class="p-4 space-y-4">
                    <div class="flex justify-between items-center bg-amber-50 p-2 rounded-xl border border-amber-100">
                        <span class="text-[9px] font-black text-amber-700 uppercase i18n" data-zh="仿真模式" data-en="Simulator">Simulator</span>
                        <div class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" id="demoMode" onchange="toggleDemoMode()"></div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="card-title-pro !text-[9px] mb-1 i18n" data-zh="波特率" data-en="Baud Rate">Baud Rate</label>
                            <input type="text" id="baudRate" class="input-pro !py-1.5" value="115200">
                            <div class="flex gap-1 mt-2">
                                <span class="badge bg-slate-100 text-slate-400 p-1 cursor-pointer hover:bg-blue-500 hover:text-white transition" style="font-size:8px" onclick="document.getElementById('baudRate').value='9600'">9600</span>
                                <span class="badge bg-slate-100 text-slate-400 p-1 cursor-pointer hover:bg-blue-500 hover:text-white transition" style="font-size:8px" onclick="document.getElementById('baudRate').value='115200'">115200</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="card-title-pro !text-[9px] mb-1 i18n" data-zh="数据位" data-en="Data">Data</label><select id="dataBits" class="input-pro !py-1"><option value="8">8B</option><option value="7">7B</option></select></div>
                            <div><label class="card-title-pro !text-[9px] mb-1 i18n" data-zh="停止位" data-en="Stop">Stop</label><select id="stopBits" class="input-pro !py-1"><option value="1">1B</option></select></div>
                        </div>
                    </div>
                    <button id="connectBtn" class="btn-pro btn-pro-dark w-full i18n" data-zh="开启连接" data-en="Open Connection" onclick="toggleConnection()">开启连接</button>
                </div>
            </div>

            <div class="card-pro">
                <div class="card-header-pro flex justify-between items-center"><span class="card-title-pro i18n" data-zh="指令宏" data-en="Macros">Macros</span><div class="flex gap-2"><button onclick="exportMacros()" class="text-slate-400 hover:text-blue-500"><i class="ri-download-2-line"></i></button><button onclick="importMacros()" class="text-slate-400 hover:text-blue-500"><i class="ri-upload-2-line"></i></button></div></div>
                <div id="macroGrid" class="p-4 grid grid-cols-1 gap-2 overflow-y-auto" style="max-height: 300px;"></div>
            </div>
        </div>

        <div class="control-column">
            <div class="card-pro mb-4">
                <div class="card-header-pro flex justify-between items-center"><span class="card-title-pro i18n" data-zh="自动回复" data-en="Responder">Responder</span><button onclick="showAutoReplyEditor()" class="text-blue-500"><i class="ri-add-circle-fill text-lg"></i></button></div>
                <div id="autoReplyEditor" class="hidden p-4 bg-slate-50 border-b border-slate-100 space-y-3">
                    <input type="text" id="autoMatchInput" class="input-pro bg-white i18n-ph" data-zh-ph="当收到..." data-en-ph="When receive..." placeholder="当收到...">
                    <input type="text" id="autoReplyInput" class="input-pro bg-white i18n-ph" data-zh-ph="则回复..." data-en-ph="Then reply..." placeholder="则回复...">
                    <button onclick="saveAutoReply()" class="btn-pro btn-pro-dark w-full !py-1.5 i18n" data-zh="添加规则" data-en="Add Rule">添加规则</button>
                </div>
                <div id="autoReplyList" class="p-4 space-y-2 overflow-y-auto" style="max-height: 250px;"></div>
            </div>

            <div class="card-pro">
                <div class="card-header-pro flex justify-between items-center"><span class="card-title-pro i18n" data-zh="高亮标记" data-en="Highlighter">Highlighter</span>
                    <div class="flex gap-2">
                        <button onclick="addHighlightRule()" class="text-indigo-500 hover:scale-110 transition-transform" title="Add Keyword"><i class="ri-add-circle-fill text-lg"></i></button>
                    </div>
                </div>
                <div id="highlightRules" class="p-4 space-y-2"></div>
            </div>

            <div class="mt-auto space-y-3">
                <button onclick="downloadLog()" class="btn-pro bg-white border border-slate-200 text-slate-600 w-full i18n" data-zh="导出日志" data-en="Export Log"><i class="ri-file-download-line"></i> 导出日志</button>
                <div class="p-4 bg-blue-50 border border-blue-100 rounded-2xl"><p class="m-0 text-[9px] font-black text-blue-600 leading-relaxed uppercase tracking-widest"><i class="ri-shield-check-fill"></i> Local Security Enabled</p></div>
            </div>
        </div>
    </section>

    <!-- 宏编辑器弹窗 -->
    <div id="macroEditor" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-sm">
            <h6 class="font-black mb-6 uppercase">Edit Macro</h6>
            <input type="hidden" id="macroIndex" value="-1">
            <div class="space-y-4">
                <input type="text" id="macroLabelInput" class="input-pro" placeholder="显示名称">
                <input type="text" id="macroCmdInput" class="input-pro font-mono" placeholder="指令内容">
                <div class="flex items-center gap-4">
                    <div><label class="card-title-pro !text-[9px] mb-1">周期(ms)</label><input type="number" id="macroIntervalInput" class="input-pro !py-1 w-24"></div>
                    <label class="check-label pt-4"><input type="checkbox" id="macroIsHex"> HEX</label>
                </div>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="saveMacro()" class="btn-pro btn-pro-dark flex-1">保存</button><button onclick="hideMacroEditor()" class="btn-pro bg-slate-100 text-slate-600">取消</button></div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('serial_tool.static', filename='js/serial.js') }}?v={{ range(1,9999)|random }}"></script>
<script>
    function onLangChange() {
        // 更新所有的 placeholder
        document.querySelectorAll('.i18n-ph').forEach(el => {
            const ph = el.getAttribute('data-' + currentLang + '-ph');
            if(ph) el.placeholder = ph;
        });

        // 动态更新网页标题
        document.title = (currentLang === 'zh' ? "云端串口调试 Pro" : "Serial Studio Pro") + " | 618002.xyz";
        
        // 特殊处理连接按钮的动态文本
        const btn = document.getElementById('connectBtn');
        if(btn) {
            if(typeof port !== 'undefined' && port) {
                btn.innerHTML = currentLang === 'zh' ? '<i class="ri-plug-fill"></i> 断开连接' : '<i class="ri-plug-fill"></i> Disconnect';
            } else {
                btn.innerHTML = currentLang === 'zh' ? '<i class="ri-plug-line"></i> 开启连接' : '<i class="ri-plug-line"></i> Open Connection';
            }
        }
    }
    // 初始化
    setTimeout(onLangChange, 100);
</script>
{% endblock %}
