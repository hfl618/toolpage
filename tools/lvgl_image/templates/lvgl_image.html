{% extends "layout.html" %}

{% block title %}LVGL LVGL图像处理{% endblock %}
{% block app_icon %}L{% endblock %}
{% block app_name %}LVGL Image{% endblock %}

{% block extra_css %}
<style>
    .upload-zone { border: 2px dashed #e2e8f0; border-radius: 24px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.3s; background: linear-gradient(145deg, #ffffff, #f8fafc); position: relative; overflow: hidden; }
    .upload-zone:hover { border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1); }
    .upload-hint-box { background: #f1f5f9; padding: 2px 10px; border-radius: 100px; font-size: 9px; font-weight: 800; color: #94a3b8; display: inline-block; margin-top: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
    .compress-btn { display: block; border: 1px solid #e2e8f0; border-radius: 12px; padding: 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 800; font-size: 11px; color: #64748b; background: white; }
    input[name="compress"]:checked + .compress-btn { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; }
    #image-preview { max-height: 240px; max-width: 100%; object-fit: contain; border-radius: 16px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); border: 4px solid white; background: #f8fafc; }
    .form-label { font-size: 0.75rem; font-weight: 800; color: #64748b; margin-bottom: 0.6rem; text-transform: uppercase; }
    .form-select, .form-control { border-radius: 12px; border: 1px solid #e2e8f0; padding: 8px 12px; font-weight: 600; font-size: 0.85rem; }
    .status-pill { padding: 10px 16px; border-radius: 12px; font-weight: 700; font-size: 13px; }
    pre { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; font-family: inherit; font-size: 13px; line-height: 1.6; white-space: pre-wrap; text-align: left; }
</style>
{% endblock %}

{% block content %}
    <div class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tighter mb-1 i18n" data-zh="LVGL 图像处理" data-en="LVGL Asset Studio">资产工作台</h1>
            <p class="text-xs text-slate-400 font-bold i18n" data-zh="高性能嵌入式图形转换中心" data-en="High-performance embedded graphics converter">高性能嵌入式图形转换中心</p>
        </div>
        <div class="flex items-center gap-2 pb-1">
            <div id="usage-badge" class="hidden px-3 py-1.5 bg-white border border-slate-100 rounded-xl text-[10px] font-black text-slate-400 shadow-sm">
                <span class="i18n" data-zh="余量:" data-en="Quota:">余量:</span> <span id="remaining-count" class="text-blue-500 font-extrabold">-</span>
            </div>
            <button type="button" onclick="openDocs()" class="px-4 h-9 flex items-center gap-2 bg-slate-900 text-white rounded-xl hover:bg-slate-800 shadow-lg transition-all active:scale-95">
                <i class="ri-book-open-line text-sm"></i>
                <span class="text-[10px] font-black uppercase i18n" data-zh="使用说明" data-en="Docs">使用说明</span>
            </button>
        </div>
    </div>

    <form id="convert-form" enctype="multipart/form-data">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card-apple p-6 h-full bg-white/50 backdrop-blur-sm">
                    <label class="form-label i18n" data-zh="原始素材" data-en="Source Media">原始素材</label>
                    <div class="upload-zone" onclick="document.getElementById('file-input').click()" id="drop-zone">
                        <div class="w-14 h-14 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="ri-upload-cloud-2-line text-2xl"></i></div>
                        <h3 class="text-base font-black text-slate-800 m-0 i18n" data-zh="选择素材" data-en="Pick Asset">选择素材</h3>
                        <div class="upload-hint-box">PNG / JPG / BMP</div>
                        <input type="file" name="file" id="file-input" class="hidden" accept="image/*">
                    </div>
                    <div id="preview-container" class="hidden mt-6 text-center">
                        <img id="image-preview" src="#" alt="Preview">
                        <div class="mt-4 flex justify-between items-center px-2">
                            <span id="img-info" class="text-[9px] font-black text-slate-400 uppercase"></span>
                            <button type="button" onclick="resetFile()" class="text-red-500 text-[10px] font-black i18n" data-zh="移除" data-en="Remove">移除</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card-apple p-6">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label i18n" data-zh="目标版本" data-en="Version">目标版本</label>
                            <select name="lv_version" class="form-select font-bold">
                                <option value="v9" selected>v9 (Latest)</option>
                                <option value="v8">v8 (Legacy)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label i18n" data-zh="导出目标" data-en="Format">导出目标</label>
                            <select name="ofmt" class="form-select font-bold">
                                <option value="C" selected>C Array (.c)</option>
                                <option value="BIN">Binary (.bin)</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label i18n" data-zh="输出命名" data-en="Output Name">输出命名</label>
                            <input type="text" name="output_name" id="output_name" placeholder="ui_img_logo" class="form-control font-bold">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label i18n" data-zh="跨行对齐" data-en="Align">跨行对齐</label>
                            <select name="align" class="form-select font-bold">
                                <option value="1">1 Byte</option>
                                <option value="4" selected>4 Bytes</option>
                                <option value="16">16 Bytes</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label i18n" data-zh="背景填充" data-en="Background">背景填充</label>
                            <div class="flex gap-2">
                                <input type="color" name="background" value="#000000" class="form-control form-control-color w-10 h-9 p-1">
                                <input type="text" id="bg-hex" value="#000000" class="form-control flex-1 text-[10px] font-mono font-bold uppercase">
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label i18n" data-zh="输出尺寸" data-en="Resize">输出尺寸</label>
                            <div class="flex gap-3 items-center bg-slate-50 p-2 rounded-xl border border-slate-100">
                                <input type="number" name="target_w" id="target_w" placeholder="W" class="form-control text-center font-black py-1">
                                <span class="text-slate-300">×</span>
                                <input type="number" name="target_h" id="target_h" placeholder="H" class="form-control text-center font-black py-1">
                                <button type="button" id="lock-ratio" class="p-1.5 text-blue-500 bg-white rounded-lg shadow-sm border border-slate-100"><i class="ri-lock-2-fill"></i></button>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label i18n" data-zh="颜色格式" data-en="Color Format">颜色格式</label>
                            <select name="cf" class="form-select font-mono text-xs font-bold">
                                <option value="AUTO">AUTO (Smart)</option>
                                <optgroup label="RGB Bitmaps">
                                    <option value="RGB565">RGB565 (16-bit)</option>
                                    <option value="RGB565A8" selected>RGB565A8 (16-bit + Alpha)</option>
                                    <option value="RGB565_SWAPPED">RGB565 Swapped</option>
                                    <option value="ARGB8565">ARGB8565 (24-bit)</option>
                                    <option value="RGB888">RGB888 (24-bit)</option>
                                    <option value="ARGB8888">ARGB8888 (32-bit)</option>
                                </optgroup>
                                <optgroup label="Alpha & Grayscale">
                                    <option value="A8">A8 (Alpha Mask)</option>
                                    <option value="L8">L8 (Grayscale)</option>
                                    <option value="AL88">AL88 (Grey + Alpha)</option>
                                </optgroup>
                                <optgroup label="Indexed (Paletted)">
                                    <option value="I1">I1 (2 Colors)</option>
                                    <option value="I2">I2 (4 Colors)</option>
                                    <option value="I4">I4 (16 Colors)</option>
                                    <option value="I8">I8 (256 Colors)</option>
                                </optgroup>
                                <optgroup label="Runtime Decoders">
                                    <option value="RAW">RAW (PNG/JPG pass-through)</option>
                                    <option value="RAW_ALPHA">RAW_ALPHA</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label i18n" data-zh="压缩策略" data-en="Compression">压缩策略</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label><input type="radio" name="compress" value="NONE" checked class="hidden peer"><div class="compress-btn peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-500">None</div></label>
                                <label><input type="radio" name="compress" value="RLE" class="hidden peer"><div class="compress-btn peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-500">RLE</div></label>
                                <label><input type="radio" name="compress" value="LZ4" class="hidden peer"><div class="compress-btn peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-500">LZ4</div></label>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="flex gap-4 pt-1">
                                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="dither" value="true" id="dither"><label class="form-check-label text-[10px] font-black text-slate-500 ml-1" for="dither">Dither</label></div>
                                <div class="form-check form-switch"><input class="form-check-input" type="checkbox" name="premultiply" value="true" id="premul"><label class="form-check-label text-[10px] font-black text-slate-500 ml-1" for="premul">Premul</label></div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-4">
                            <button type="submit" id="submit-btn" class="btn-apple-primary w-full py-4 text-base shadow-xl i18n flex items-center justify-center gap-3 group overflow-hidden relative" data-zh="立即转换并下载资产" data-en="Convert & Download">
                                <span class="relative z-10 i18n" data-zh="立即转换并下载资产" data-en="Convert & Download">立即转换并导出代码</span>
                                <i class="ri-arrow-right-line group-hover:translate-x-1 transition-transform relative z-10"></i>
                                <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            </button>
                        </div>
                    </div>
                    <div id="status" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>
    </form>

    <div class="modal fade" id="docsModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content border-0 shadow-2xl rounded-[32px] overflow-hidden"><div class="modal-header border-0 p-6 pb-0 flex justify-between items-center"><h3 class="text-xl font-black i18n" data-zh="转换指南" data-en="Guide">转换指南</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-6 overflow-y-auto max-h-[70vh]"><div id="docs-content"></div></div></div></div></div>
{% endblock %}

{% block extra_js %}
<script>
    const translations = {
        zh: { docs: `{{ docs_zh | safe }}`, success: "导出成功！", error: "导出失败: ", no_file: "请先上传图片" },
        en: { docs: `{{ docs_en | safe }}`, success: "Success!", error: "Failed: ", no_file: "Pick an image" }
    };

    function onLangChange() { updateUsage(); }
    function openDocs() {
        document.getElementById('docs-content').innerHTML = `<pre>${translations[currentLang].docs}</pre>`;
        bootstrap.Modal.getOrCreateInstance(document.getElementById('docsModal')).show();
    }

    async function updateUsage() {
        try {
            const r = await fetch('/lvgl_image/usage');
            const d = await r.json();
            const badge = document.getElementById('usage-badge');
            const count = document.getElementById('remaining-count');
            if(d.success && badge && count) {
                badge.classList.remove('hidden');
                count.innerText = d.remaining;
                count.className = d.remaining <= 0 ? "text-red-500 font-extrabold" : "text-blue-500 font-extrabold";
            }
        } catch(e){}
    }

    const form = document.getElementById('convert-form');
    const fileIn = document.getElementById('file-input');
    const targetW = document.getElementById('target_w'), targetH = document.getElementById('target_h');
    const lockBtn = document.getElementById('lock-ratio');
    let ratio = 1, isLocked = true;

    form.onsubmit = async (e) => {
        e.preventDefault();
        if(!fileIn.files.length) return showToast(translations[currentLang].no_file, 'error');
        const status = document.getElementById('status');
        status.classList.remove('hidden');
        status.innerHTML = `<div class="status-pill bg-blue-50 text-blue-600 border border-blue-100 shadow-sm"><i class="ri-loader-4-line animate-spin"></i> Converting...</div>`;
        try {
            const res = await fetch('{{ url_for("lvgl_image.convert") }}', { method: 'POST', body: new FormData(form) });
            if (res.ok) {
                const blob = await res.blob();
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                const disp = res.headers.get('Content-Disposition');
                a.download = (disp && disp.includes('filename=')) ? disp.split('filename=')[1].replace(/"/g, '') : "lv_assets.c";
                a.click();
                status.innerHTML = `<div class="status-pill bg-emerald-50 text-emerald-600 border border-emerald-100 shadow-sm"><i class="ri-check-line"></i> ${translations[currentLang].success}</div>`;
                updateUsage();
            } else { throw new Error((await res.json()).error); }
        } catch (err) { status.innerHTML = `<div class="status-pill bg-red-50 text-red-600 border border-red-100 shadow-sm"><i class="ri-error-warning-fill"></i> ${err.message}</div>`; }
    };

    fileIn.onchange = () => {
        const [f] = fileIn.files;
        if (f) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('drop-zone').classList.add('hidden');
                const img = new Image();
                img.onload = () => {
                    document.getElementById('img-info').innerText = `${img.width}×${img.height} PX`;
                    ratio = img.width / img.height;
                    targetW.placeholder = img.width; targetH.placeholder = img.height;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(f);
        }
    };

    function resetFile() {
        fileIn.value = '';
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('drop-zone').classList.remove('hidden');
    }

    if(lockBtn) lockBtn.onclick = () => { isLocked = !isLocked; lockBtn.innerHTML = isLocked ? '<i class="ri-lock-2-fill"></i>' : '<i class="ri-lock-unlock-line"></i>'; lockBtn.classList.toggle('text-blue-500'); lockBtn.classList.toggle('text-slate-400'); };
    if(targetW && targetH) {
        targetW.oninput = () => { if(isLocked && targetW.value) targetH.value = Math.round(targetW.value / ratio); };
        targetH.oninput = () => { if(isLocked && targetH.value) targetW.value = Math.round(targetH.value * ratio); };
    }

    const bgP = document.querySelector('input[name="background"]'), bgH = document.getElementById('bg-hex');
    if(bgP && bgH) { bgP.oninput = () => bgH.value = bgP.value.toUpperCase(); bgH.oninput = () => { if(/^#[0-9A-F]{6}$/i.test(bgHex.value)) bgP.value = bgH.value; }; }

    updateUsage();
</script>
{% endblock %}
