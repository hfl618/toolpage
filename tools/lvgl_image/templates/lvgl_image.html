{% extends "layout.html" %}

{% block title %}LVGL 图像处理{% endblock %}
{% block app_icon %}L{% endblock %}
{% block app_name %}LVGL Image{% endblock %}

{% block extra_css %}
<style>
    /* 1. 交互优化：覆盖 Bootstrap 默认聚焦样式，与整体风格统一 */
    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }
    
    /* 2. 上传区域：更现代的虚线边框和悬浮反馈 */
    .upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #f8fafc;
        position: relative;
        overflow: hidden;
    }
    .upload-zone:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-2px);
    }

    /* 3. 压缩选项：iOS 风格分段控制器 (Segmented Control) */
    .segmented-control {
        background: #f1f5f9;
        padding: 4px;
        border-radius: 14px;
        display: flex;
    }
    .segment-btn {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 11px;
        font-weight: 800;
        color: #64748b;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
    }
    /* 选中状态 */
    input[name="compress"]:checked + .segment-btn {
        background: white;
        color: #0f172a;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* 4. 透明背景网格：用于预览带透明度的图片 */
    .preview-bg {
        background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
        background-size: 10px 10px;
        background-color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
    <div class="mb-10 flex flex-col md:flex-row justify-between items-end gap-6">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight mb-2 i18n" data-zh="资产工作台" data-en="Asset Studio">资产工作台</h1>
            <p class="text-sm font-semibold text-slate-400 i18n" data-zh="高性能嵌入式图形转换引擎" data-en="High-performance embedded graphics converter">高性能嵌入式图形转换引擎</p>
        </div>
        <div class="flex items-center gap-3">
            <div id="usage-badge" class="hidden px-4 py-2 bg-white border border-slate-200 rounded-2xl text-xs font-bold text-slate-500 shadow-sm flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                <span class="i18n" data-zh="余量:" data-en="Quota:">余量:</span> 
                <span id="remaining-count" class="text-slate-900 font-black">-</span>
            </div>
            <button type="button" onclick="openDocs()" class="px-5 py-2.5 flex items-center gap-2 bg-white text-slate-700 border border-slate-200 rounded-2xl hover:bg-slate-50 hover:border-slate-300 transition-all font-bold text-xs shadow-sm">
                <i class="ri-book-open-line"></i>
                <span class="i18n" data-zh="使用说明" data-en="Docs">使用说明</span>
            </button>
        </div>
    </div>

    <form id="convert-form" enctype="multipart/form-data">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 flex flex-col gap-6">
                <div class="card-apple p-1 h-full flex flex-col">
                    <div class="p-6 border-b border-slate-50">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-wider i18n" data-zh="原始素材" data-en="Source Media">原始素材</label>
                    </div>
                    
                    <div class="p-6 flex-1 flex flex-col justify-center">
                        <div class="upload-zone py-12 px-6 text-center cursor-pointer group" onclick="document.getElementById('file-input').click()" id="drop-zone">
                            <div class="w-16 h-16 bg-white rounded-3xl shadow-sm border border-slate-100 flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                                <i class="ri-image-add-line text-3xl text-blue-500"></i>
                            </div>
                            <h3 class="text-sm font-black text-slate-900 mb-2 i18n" data-zh="点击或拖拽上传" data-en="Click to Upload">点击或拖拽上传</h3>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">PNG / JPG / BMP</p>
                            <input type="file" name="file" id="file-input" class="hidden" accept="image/*">
                        </div>

                        <div id="preview-container" class="hidden flex flex-col h-full">
                            <div class="preview-bg rounded-2xl border border-slate-100 p-2 flex-1 flex items-center justify-center relative overflow-hidden group">
                                <img id="image-preview" src="#" alt="Preview" class="max-h-[300px] max-w-full object-contain rounded-lg shadow-lg relative z-10">
                            </div>
                            
                            <div class="mt-4 flex items-center justify-between bg-slate-50 px-4 py-3 rounded-xl border border-slate-100">
                                <div class="flex items-center gap-2">
                                    <i class="ri-information-fill text-slate-400"></i>
                                    <span id="img-info" class="text-xs font-black text-slate-600 font-mono"></span>
                                </div>
                                <button type="button" onclick="resetFile()" class="w-8 h-8 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-red-500 hover:bg-red-50 hover:border-red-200 transition-colors shadow-sm">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="card-apple p-8">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-lg font-black text-slate-900 i18n" data-zh="转换配置" data-en="Configuration">转换配置</h2>
                        <div id="status" class="hidden"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="LVGL 版本" data-en="Target Version">LVGL 版本</label>
                            <select name="lv_version" class="form-select w-full bg-slate-50 border-slate-200 rounded-xl text-sm font-bold text-slate-700 py-2.5 focus:bg-white transition-colors">
                                <option value="v9" selected>LVGL v9 (Latest)</option>
                                <option value="v8">LVGL v8 (Legacy)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="导出格式" data-en="Output Format">导出格式</label>
                            <select name="ofmt" class="form-select w-full bg-slate-50 border-slate-200 rounded-xl text-sm font-bold text-slate-700 py-2.5 focus:bg-white transition-colors">
                                <option value="C" selected>C Array (.c)</option>
                                <option value="BIN">Binary (.bin)</option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="输出命名 (不填默认图片名)" data-en="Output Name (Default to image name)">输出命名 (不填默认图片名)</label>
                            <input type="text" name="output_name" id="output_name" placeholder="ui_img_logo" class="form-control w-full bg-slate-50 border-slate-200 rounded-xl text-sm font-bold text-slate-700 py-2.5 focus:bg-white transition-colors">
                        </div>

                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="内存对齐" data-en="Memory Align">内存对齐</label>
                            <select name="align" class="form-select w-full bg-slate-50 border-slate-200 rounded-xl text-sm font-bold text-slate-700 py-2.5">
                                <option value="1">1 Byte (Compact)</option>
                                <option value="4" selected>4 Bytes (Standard)</option>
                                <option value="16">16 Bytes (DMA Safe)</option>
                                <option value="32">32 Bytes (Cache Line)</option>
                                <option value="64">64 Bytes (Ultra-High)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="背景填充色" data-en="Background Fill">背景填充色</label>
                            <div class="flex gap-2">
                                <div class="relative w-10 h-10 flex-shrink-0">
                                    <input type="color" name="background" value="#000000" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                    <div class="w-full h-full rounded-xl border border-slate-200 shadow-sm" style="background-color: #000000" id="color-preview"></div>
                                </div>
                                <input type="text" id="bg-hex" value="#000000" class="form-control w-full bg-slate-50 border-slate-200 rounded-xl text-sm font-mono font-bold text-slate-700 uppercase">
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="输出尺寸 (PX)" data-en="Resize (PX)">输出尺寸 (PX)</label>
                            <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 p-1.5 rounded-xl">
                                <input type="number" name="target_w" id="target_w" placeholder="W" class="form-control border-0 bg-transparent text-center font-black text-slate-700 focus:ring-0 text-sm">
                                <span class="text-slate-300 font-light">×</span>
                                <input type="number" name="target_h" id="target_h" placeholder="H" class="form-control border-0 bg-transparent text-center font-black text-slate-700 focus:ring-0 text-sm">
                                <button type="button" id="lock-ratio" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg border border-slate-200 text-blue-500 shadow-sm hover:text-blue-600 transition-colors">
                                    <i class="ri-lock-2-fill text-xs"></i>
                                </button>
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="色彩格式" data-en="Color Format">色彩格式</label>
                            <select name="cf" class="form-select w-full bg-slate-50 border-slate-200 rounded-xl text-sm font-mono font-bold text-slate-700 py-2.5 focus:bg-white transition-colors">
                                <option value="AUTO">AUTO (Smart Detect)</option>
                                <optgroup label="RGB Bitmaps">
                                    <option value="RGB565">RGB565 (16-bit)</option>
                                    <option value="RGB565A8" selected>RGB565A8 (16-bit + Alpha)</option>
                                    <option value="RGB565_SWAPPED">RGB565 Swapped</option>
                                    <option value="ARGB8565">ARGB8565 (24-bit)</option>
                                    <option value="RGB888">RGB888 (24-bit)</option>
                                    <option value="ARGB8888">ARGB8888 (32-bit)</option>
                                </optgroup>
                                <optgroup label="Alpha & Grayscale">
                                    <option value="A8">A8 (Alpha Mask)</option>
                                    <option value="L8">L8 (Grayscale)</option>
                                    <option value="AL88">AL88 (Grey + Alpha)</option>
                                </optgroup>
                                <optgroup label="Indexed (Paletted)">
                                    <option value="I1">I1 (2 Colors)</option>
                                    <option value="I2">I2 (4 Colors)</option>
                                    <option value="I4">I4 (16 Colors)</option>
                                    <option value="I8">I8 (256 Colors)</option>
                                </optgroup>
                                <optgroup label="Runtime Decoders">
                                    <option value="RAW">RAW (PNG/JPG pass-through)</option>
                                    <option value="RAW_ALPHA">RAW_ALPHA</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-2 i18n" data-zh="压缩策略" data-en="Compression">压缩策略</label>
                            <div class="segmented-control">
                                <label class="flex-1">
                                    <input type="radio" name="compress" value="NONE" checked class="hidden peer">
                                    <div class="segment-btn">None</div>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="compress" value="RLE" class="hidden peer">
                                    <div class="segment-btn">RLE (Run-Length)</div>
                                </label>
                                <label class="flex-1">
                                    <input type="radio" name="compress" value="LZ4" class="hidden peer">
                                    <div class="segment-btn">LZ4 (Fast)</div>
                                </label>
                            </div>
                        </div>

                        <div class="md:col-span-2 flex flex-wrap gap-6 pt-2">
                            <div class="form-check form-switch flex items-center gap-2 pl-0">
                                <input class="form-check-input float-none m-0 focus:shadow-none" type="checkbox" name="dither" value="true" id="dither" style="width: 2.5em; height: 1.5em;">
                                <label class="form-check-label text-xs font-bold text-slate-600 cursor-pointer select-none" for="dither">Dithering (抖动)</label>
                            </div>
                            <div class="form-check form-switch flex items-center gap-2 pl-0">
                                <input class="form-check-input float-none m-0 focus:shadow-none" type="checkbox" name="premultiply" value="true" id="premul" style="width: 2.5em; height: 1.5em;">
                                <label class="form-check-label text-xs font-bold text-slate-600 cursor-pointer select-none" for="premul">Premultiply Alpha</label>
                            </div>
                            <div class="form-check form-switch flex items-center gap-2 pl-0">
                                <input class="form-check-input float-none m-0 focus:shadow-none" type="checkbox" name="nemagfx" value="true" id="nemagfx" style="width: 2.5em; height: 1.5em;">
                                <label class="form-check-label text-xs font-bold text-slate-600 cursor-pointer select-none i18n" for="nemagfx" data-zh="NEMA 加速优化" data-en="NEMA-GFX Optimized">NEMA 加速优化</label>
                            </div>
                        </div>

                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <button type="submit" id="submit-btn" class="w-full py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-2xl shadow-xl shadow-slate-200 transition-all active:scale-[0.98] flex items-center justify-center gap-3 group">
                            <span class="font-black text-sm uppercase tracking-wide i18n" data-zh="开始转换并下载" data-en="Convert & Download">开始转换并下载</span>
                            <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center group-hover:translate-x-1 transition-transform">
                                <i class="ri-arrow-right-line text-sm"></i>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="modal fade" id="docsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-2xl rounded-[32px] overflow-hidden">
                <div class="modal-header border-b border-slate-100 p-6 bg-white">
                    <h3 class="text-xl font-black text-slate-900 i18n" data-zh="LVGL 图像转换指南" data-en="LVGL Image Converter Guide">LVGL 图像转换指南</h3>
                    <button type="button" class="btn-close opacity-50 hover:opacity-100" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-8 bg-slate-50/50">
                    <div id="docs-content" class="prose prose-sm max-w-none text-slate-600 font-medium"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    const translations = {
        zh: { docs: {{ docs_zh | tojson | safe }}, success: "处理完成", error: "转换失败: ", no_file: "请先选择一张图片" },
        en: { docs: {{ docs_en | tojson | safe }}, success: "Completed", error: "Failed: ", no_file: "Please select an image first" }
    };

    // 监听全局语言切换事件 (由 layout.html 触发)
    window.addEventListener('languageChanged', function() {
        updateUsage();
    });

    function openDocs() {
        const lang = localStorage.getItem('lang') || 'zh';
        let raw = translations[lang].docs;
        
        // 简易 Markdown 渲染逻辑
        let html = raw
            .replace(/^# (.*$)/gm, '<h2 class="text-2xl font-black text-slate-900 mb-6 border-b-4 border-blue-500 pb-2">$1</h2>')
            .replace(/^## (.*$)/gm, '<h3 class="text-lg font-black text-slate-800 mt-8 mb-4 flex items-center gap-2"><i class="ri-settings-3-fill text-blue-500"></i> $1</h3>')
            .replace(/^- (.*$)/gm, '<li class="ml-4 mb-2 text-slate-600 font-bold list-none flex items-start gap-2"><div class="w-1.5 h-1.5 rounded-full bg-blue-400 mt-1.5 flex-shrink-0"></div><span>$1</span></li>')
            .replace(/^---$/gm, '<hr class="my-8 border-slate-100">')
            .replace(/\*(.*?)\*/g, '<i class="text-slate-400 text-xs">$1</i>')
            .replace(/`(.*?)`/g, '<code class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded-md font-mono text-xs font-black">$1</code>');

        document.getElementById('docs-content').innerHTML = '<div class="space-y-2">' + html + '</div>';
        bootstrap.Modal.getOrCreateInstance(document.getElementById('docsModal')).show();
    }

    async function updateUsage() {
        try {
            const r = await fetch('/lvgl_image/usage');
            const d = await r.json();
            const badge = document.getElementById('usage-badge');
            const count = document.getElementById('remaining-count');
            if(d.success && badge && count) {
                badge.classList.remove('hidden');
                count.innerText = d.remaining;
                count.className = d.remaining <= 0 ? "text-red-500 font-black" : "text-slate-900 font-black";
            }
        } catch(e){}
    }

    const form = document.getElementById('convert-form');
    const fileIn = document.getElementById('file-input');
    const targetW = document.getElementById('target_w'), targetH = document.getElementById('target_h');
    const lockBtn = document.getElementById('lock-ratio');
    let ratio = 1, isLocked = true;

    form.onsubmit = async (e) => {
        e.preventDefault();
        const lang = localStorage.getItem('lang') || 'zh';
        if(!fileIn.files.length) return showToast(translations[lang].no_file, 'error');
        
        const status = document.getElementById('status');
        status.classList.remove('hidden');
        status.innerHTML = `
            <div class="flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold animate-pulse">
                <i class="ri-loader-4-line animate-spin"></i> Processing...
            </div>`;
            
        try {
            const res = await fetch('{{ url_for("lvgl_image.convert") }}', { method: 'POST', body: new FormData(form) });
            if (res.ok) {
                const blob = await res.blob();
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                const disp = res.headers.get('Content-Disposition');
                a.download = (disp && disp.includes('filename=')) ? disp.split('filename=')[1].replace(/"/g, '') : "lv_assets.c";
                a.click();
                
                status.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-lg text-xs font-bold">
                        <i class="ri-check-double-line"></i> ${translations[lang].success}
                    </div>`;
                updateUsage();
            } else { 
                const errData = await res.json();
                throw new Error(errData.error || "Unknown Error"); 
            }
        } catch (err) { 
            status.innerHTML = `
                <div class="flex items-center gap-2 px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-xs font-bold">
                    <i class="ri-error-warning-line"></i> ${err.message}
                </div>`;
        }
    };

    fileIn.onchange = () => {
        const [f] = fileIn.files;
        if (f) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('drop-zone').classList.add('hidden');
                const img = new Image();
                img.onload = () => {
                    document.getElementById('img-info').innerText = `${img.width} × ${img.height} PX`;
                    ratio = img.width / img.height;
                    targetW.placeholder = img.width; targetH.placeholder = img.height;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(f);
        }
    };

    function resetFile() {
        fileIn.value = '';
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('drop-zone').classList.remove('hidden');
    }

    if(lockBtn) lockBtn.onclick = () => { 
        isLocked = !isLocked; 
        lockBtn.innerHTML = isLocked ? '<i class="ri-lock-2-fill text-xs"></i>' : '<i class="ri-lock-unlock-line text-xs"></i>'; 
        lockBtn.classList.toggle('text-blue-500'); 
        lockBtn.classList.toggle('text-slate-400'); 
        if(isLocked) { // Re-lock sync
             if(targetW.value) targetH.value = Math.round(targetW.value / ratio);
        }
    };
    
    if(targetW && targetH) {
        targetW.oninput = () => { if(isLocked && targetW.value) targetH.value = Math.round(targetW.value / ratio); };
        targetH.oninput = () => { if(isLocked && targetH.value) targetW.value = Math.round(targetH.value * ratio); };
    }

    // Color picker sync
    const bgP = document.querySelector('input[name="background"]'), bgH = document.getElementById('bg-hex'), bgPreview = document.getElementById('color-preview');
    if(bgP && bgH) { 
        bgP.oninput = () => { 
            bgH.value = bgP.value.toUpperCase(); 
            bgPreview.style.backgroundColor = bgP.value; 
        }; 
        bgH.oninput = () => { 
            if(/^#[0-9A-F]{6}$/i.test(bgH.value)) { 
                bgP.value = bgH.value; 
                bgPreview.style.backgroundColor = bgH.value;
            } 
        }; 
    }

    updateUsage();
</script>
{% endblock %}