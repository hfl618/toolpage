{% extends "support/layout.html" %}

{% block title %}系统更新 Pro{% endblock %}
{% block app_icon %}<i class="ri-refresh-line"></i>{% endblock %}
{% block app_name %}系统更新{% endblock %}

{% block extra_css %}
<style>
    :root { --mac-bg: #f8fafc; --accent: #007aff; }
    body { background-color: var(--mac-bg); color: #1e293b; }
    .card-pro { background: white; border: 1px solid #e2e8f0; border-radius: 32px; padding: 32px; box-shadow: 0 20px 50px -12px rgba(0,0,0,0.05); }
    .status-badge { padding: 4px 12px; border-radius: 100px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
    .badge-latest { background: #dcfce7; color: #15803d; }
    .partition-row { padding: 16px 0; border-bottom: 1px solid #f1f5f9; transition: 0.2s; }
    .partition-row:last-child { border-bottom: none; }
    .btn-update { background: #0f172a; color: white; padding: 16px; border-radius: 20px; font-weight: 800; font-size: 14px; border: none; cursor: pointer; transition: 0.2s; }
    .btn-update:hover { transform: scale(1.02); background: #1e293b; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-md mx-auto py-6">
    <div class="card-pro">
        <!-- 头部状态 -->
        <div class="text-center mb-10">
            <div id="status-box" class="w-20 h-20 bg-blue-50 text-blue-500 rounded-[28px] flex items-center justify-center mx-auto mb-6 shadow-sm transition-all">
                <i id="main-icon" class="ri-cloud-line text-4xl"></i>
            </div>
            <h2 id="status-title" class="text-2xl font-black text-slate-900 tracking-tight">固件检查中心</h2>
            <div class="mt-4 flex items-center justify-center gap-2">
                <div class="group relative cursor-pointer" onclick="switchSpace()">
                    <div class="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-2xl shadow-xl shadow-slate-200 border border-slate-800 hover:bg-blue-600 hover:border-blue-500 transition-all">
                        <i class="ri-instance-line text-blue-400"></i>
                        <span id="viewing-space" class="text-[11px] font-black uppercase tracking-widest">Space #---</span>
                        <i class="ri-arrow-up-down-line text-slate-500 text-[10px]"></i>
                    </div>
                    <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[8px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none z-10">点击切换空间 / Click to Switch</div>
                </div>
            </div>
        </div>

        <!-- 分区列表 -->
        <div id="partition-list" class="mb-10 space-y-1"></div>

        <!-- 操作区 -->
        <div class="space-y-4">
            <button onclick="checkUpdates()" id="btn-action" class="btn-update w-full flex items-center justify-center gap-2">
                <i class="ri-refresh-line"></i> 检查更新
            </button>
            <button onclick="openHistory(userUid, false)" class="w-full text-xs font-bold text-slate-400 hover:text-blue-500 uppercase tracking-widest transition-colors">
                <i class="ri-history-line"></i> 查看完整版本历史
            </button>
        </div>

        <div class="mt-10 pt-6 border-t border-slate-50 text-center">
            <a href="/ble_config/ota/admin" class="text-[10px] text-slate-300 hover:text-blue-400 font-black uppercase tracking-tighter">Admin Console</a>
        </div>
    </div>
</div>

{% include "history_modal.html" %}

<script>
    let userUid = '';
    // 核心预留：将来从设备读取的版本号映射
    let deviceVersions = {
        "app": "1.0.0",
        "ui": "1.0.0"
    };

    async function checkUpdates() {
        const btn = document.getElementById('btn-action');
        btn.disabled = true;
        btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> 正在检测...';

        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');
        const apiPath = (uid ? `/ble_config/ota/info?uid=${uid}` : '/ble_config/ota/info');
        const finalUrl = apiPath + (apiPath.includes('?') ? '&' : '?') + `_t=${Date.now()}`;
        
        try {
            const res = await fetch(finalUrl);
            const data = await res.json();
            userUid = data.uid;
            document.getElementById('viewing-space').innerText = `Space #${userUid}`;

            if(data.status !== "empty" && Object.keys(data).length > 4) {
                renderPartitions(data);
                document.getElementById('status-title').innerText = '检测到固件分区';
            } else {
                document.getElementById('status-title').innerText = '暂无可用固件';
                document.getElementById('partition-list').innerHTML = '';
            }
        } catch (e) { alert('连接失败'); }
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-refresh-line"></i> 检查更新';
    }

    function renderPartitions(data) {
        const list = document.getElementById('partition-list');
        list.innerHTML = '';
        Object.keys(data).filter(k => !['uid', 'status', 'last_publish', 'can_edit', 'workspace'].includes(k)).forEach(name => {
            const info = data[name];
            const deviceVer = deviceVersions[name] || "0.0.0";
            const hasUpdate = isNewerVersion(info.version, deviceVer);

            const row = document.createElement('div');
            row.className = 'partition-row flex items-center justify-between animate-[fadeIn_0.3s]';
            row.innerHTML = `
                <div class="flex flex-col">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-black text-slate-800 uppercase tracking-tight">${info.name || name}</span>
                        ${hasUpdate ? '<span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></span>' : ''}
                    </div>
                    <span class="text-[9px] text-slate-400 font-bold">Dev: v${deviceVer} | Cloud: v${info.version}</span>
                </div>
                <div class="flex items-center gap-2">
                    ${hasUpdate ? `
                        <button onclick="pushUpdateToDevice('${name}', '${info.url}')" class="bg-blue-600 text-white text-[10px] font-black px-3 py-1.5 rounded-xl shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">
                            更新
                        </button>
                    ` : `
                        <span class="text-[9px] font-black text-emerald-500 bg-emerald-50 px-2 py-1 rounded-lg">最新</span>
                    `}
                    <a href="${info.url}" target="_blank" class="w-8 h-8 rounded-lg bg-slate-50 text-slate-400 hover:text-blue-500 flex items-center justify-center transition-all">
                        <i class="ri-download-2-line"></i>
                    </a>
                </div>
            `;
            list.appendChild(row);
        });
    }

    function isNewerVersion(cloud, device) {
        const c = cloud.split('.').map(Number);
        const d = device.split('.').map(Number);
        for (let i = 0; i < Math.max(c.length, d.length); i++) {
            if ((c[i] || 0) > (d[i] || 0)) return true;
            if ((c[i] || 0) < (d[i] || 0)) return false;
        }
        return false;
    }

    function pushUpdateToDevice(partition, url) {
        alert(`【智能更新】\n系统已准备好下发更新指令到设备。\n\n目标分区: ${partition}\n最新版本 URL: ${url}\n\n指令发送逻辑已预留，可在 pushUpdateToDevice 函数中接入蓝牙发送代码。`);
    }

    function switchSpace() {
        const targetId = prompt('请输入要访问的空间 ID (UID):', userUid);
        if (targetId && targetId !== userUid) {
            window.location.href = `/ble_config/ota?uid=${targetId}`;
        }
    }

    document.addEventListener('DOMContentLoaded', checkUpdates);
</script>
{% endblock %}
