{% extends "support/layout.html" %}

{% block title %}设备蓝牙配网 Pro{% endblock %}
{% block app_icon %}<i class="ri-bluetooth-connect-line"></i>{% endblock %}
{% block app_name %}<span class="i18n" data-zh="设备配网" data-en="BLE Config">设备配网</span>{% endblock %}

{% block extra_css %}
<style>
    :root {
        --mac-bg: #f8fafc;
        --accent: #007aff;
        --success: #34c759;
        --danger: #ff3b30;
    }

    body { background-color: var(--mac-bg); }
    
    /* 适配标准布局 */
    main.max-w-7xl { 
        margin-top: 40px !important;
        padding-bottom: 60px !important;
    }

    /* 通用卡片样式 - 与项目一致 */
    .card-pro { 
        background: white; 
        border: 1px solid #e2e8f0; 
        border-radius: 20px; 
        overflow: hidden; 
        display: flex; 
        flex-direction: column; 
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02), 0 2px 4px -1px rgba(0,0,0,0.01);
        height: fit-content;
    }
    .card-header-pro { 
        padding: 16px 24px; 
        background: #f8fafc; 
        border-bottom: 1px solid #f1f5f9; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
    }
    .card-title-pro { 
        font-size: 0.75rem; 
        font-weight: 900; 
        text-transform: uppercase; 
        letter-spacing: 1.2px; 
        color: #94a3b8; 
        margin: 0; 
    }

    /* 输入框样式 */
    .input-pro { 
        background: #f1f5f9; 
        border: 2px solid transparent; 
        border-radius: 12px; 
        padding: 12px 16px; 
        font-weight: 600; 
        font-size: 14px; 
        transition: 0.2s; 
        width: 100%; 
        color: #1e293b; 
        outline: none; 
    }
    .input-pro:focus { background: white; border-color: var(--accent); }

    /* 按钮样式 - 增强稳定性 */
    .btn-pro { 
        width: 100%;
        min-height: 48px;
        padding: 12px 24px; 
        border-radius: 14px; 
        font-weight: 800; 
        font-size: 14px; 
        border: none; 
        cursor: pointer; 
        transition: all 0.2s ease; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 10px; 
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .btn-pro-dark { background: #0f172a; color: white; }
    .btn-pro-dark:hover { background: #1e293b; transform: translateY(-1px); }
    .btn-pro-accent { background: #007aff; color: white; }
    .btn-pro-accent:hover { background: #0062cc; transform: translateY(-1px); }
    .btn-pro-danger { background: #ff3b30; color: white; }
    .btn-pro-danger:hover { background: #e03127; transform: translateY(-1px); }

    /* 状态指示 */
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; position: relative; }
    .status-dot.connected { background: var(--success); box-shadow: 0 0 12px var(--success); }
    .status-dot.connected::after { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid var(--success); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }

    .wifi-row { position: relative; padding: 24px; background: #fbfcfd; border-radius: 16px; border: 1px solid #f1f5f9; transition: all 0.3s; }
    .wifi-row:hover { border-color: var(--accent); background: white; transform: translateY(-2px); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.05); }

    .feature-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .feature-btn { background: #f8fafc; border: 1px solid #f1f5f9; border-radius: 16px; padding: 20px 16px; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: 0.2s; cursor: pointer; }
    .feature-btn:hover { background: white; border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    
    .empty-state { border: 2px dashed #e2e8f0; border-radius: 16px; padding: 32px; text-align: center; color: #94a3b8; font-weight: 700; font-size: 13px; }

    /* 隐藏默认装饰 */
    main > div.mt-12 { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
    
    <!-- 左侧：Wi-Fi 配置列表 (占 8 列) -->
    <div class="lg:col-span-8 space-y-6">
        <div class="card-pro">
            <div class="card-header-pro">
                <div class="flex items-center gap-3">
                    <i class="ri-wifi-line text-blue-500 text-lg"></i>
                    <span class="card-title-pro i18n" data-zh="Wi-Fi 账号池 (最大 3 组)" data-en="Wi-Fi Account Pool (Max 3)">Wi-Fi 账号池 (最大 3 组)</span>
                </div>
                <button id="btnAddRow" onclick="addWiFiRow()" class="btn-pro btn-pro-accent" style="width: auto; min-height: unset; padding: 4px 12px; font-size: 11px; height: 30px;">
                    <i class="ri-add-line"></i> <span class="i18n" data-zh="添加备用" data-en="Add Backup">添加备用</span>
                </button>
            </div>
            
            <div id="wifiListContainer" class="p-6 space-y-4">
                <!-- 默认第一行 -->
                <div class="wifi-row border-l-4 border-blue-500">
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black text-blue-600 uppercase tracking-widest i18n" data-zh="首选连接网络" data-en="Primary Connection">首选连接网络</span>
                            <i class="ri-star-fill text-amber-400"></i>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" class="input-pro ssid-input i18n-ph" data-zh-ph="Wi-Fi 名称 (SSID)" data-en-ph="Wi-Fi SSID" placeholder="Wi-Fi 名称 (SSID)">
                            <input type="password" class="input-pro pwd-input i18n-ph" data-zh-ph="Wi-Fi 密码" data-en-ph="Wi-Fi Password" placeholder="Wi-Fi 密码">
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-slate-50/50 border-t border-slate-100">
                <button id="btnSend" class="btn-pro btn-pro-dark w-full shadow-lg !py-4 text-base disabled:opacity-50 disabled:cursor-not-allowed" onclick="collectAndSend()" disabled>
                    <i class="ri-send-plane-fill"></i> <span class="i18n" data-zh="下发配置到设备" data-en="Provision Device">下发配置到设备</span>
                </button>
            </div>
        </div>

        <div class="p-6 bg-white border border-blue-100 rounded-[24px] flex items-start gap-4 shadow-sm">
            <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 flex-shrink-0">
                <i class="ri-information-line text-xl"></i>
            </div>
            <div>
                <h4 class="text-sm font-black text-slate-800 mb-1 i18n" data-zh="配网说明" data-en="Instructions">配网说明</h4>
                <p class="text-xs text-slate-500 font-medium leading-relaxed i18n" 
                   data-zh="设备会优先尝试连接列表中的首选网络。如果失败，将依次轮询备用列表中的账号。支持信号强度优先排序算法。" 
                   data-en="Device will prioritize the primary network. If connection fails, it will rotate through backup accounts based on signal strength.">
                   设备会优先尝试连接列表中的首选网络。如果失败，将依次轮询备用列表中的账号。支持信号强度优先排序算法。
                </p>
            </div>
        </div>
    </div>

    <!-- 右侧：状态与控制 (占 4 列) -->
    <div class="lg:col-span-4 space-y-6">
        
        <!-- 设备连接状态 -->
        <div class="card-pro">
            <div class="card-header-pro">
                <span class="card-title-pro i18n" data-zh="连接状态" data-en="Connection">连接状态</span>
                <div id="bleStatusDot" class="status-dot"></div>
            </div>
            <div class="p-8 text-center">
                <div id="bleStatusText" class="text-2xl font-black text-slate-900 i18n mb-1" data-zh="未连接" data-en="Disconnected">未连接</div>
                <div id="deviceName" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-6">Device Offline</div>
                
                <button id="btnConnect" class="btn-pro btn-pro-accent" onclick="toggleBLE()">
                    <i class="ri-bluetooth-line"></i> <span id="btnConnectText" class="i18n" data-zh="搜索并连接设备" data-en="Search & Connect">搜索并连接设备</span>
                </button>
            </div>
        </div>

        <!-- 硬件指令区 -->
        <div class="card-pro" id="extFeatures" style="opacity: 0.5; pointer-events: none;">
            <div class="card-header-pro">
                <span class="card-title-pro i18n" data-zh="硬件指令" data-en="Hardware Control">硬件指令</span>
            </div>
            <div class="p-6">
                <div class="feature-grid">
                    <div class="feature-btn" onclick="sendCommand('CMD_REBOOT')">
                        <i class="ri-restart-line text-orange-500 text-xl"></i>
                        <span class="text-[11px] font-black text-slate-600 i18n" data-zh="重启" data-en="Reboot">重启</span>
                    </div>
                    <div class="feature-btn" onclick="sendCommand('CMD_FACTORY')">
                        <i class="ri-history-line text-red-500 text-xl"></i>
                        <span class="text-[11px] font-black text-slate-600 i18n" data-zh="重置" data-en="Reset">重置</span>
                    </div>
                    <div class="feature-btn" onclick="alert(currentLang === 'zh' ? '即将开启 OTA 升级通道' : 'Opening OTA...')">
                        <i class="ri-cloud-windy-line text-purple-500 text-xl"></i>
                        <span class="text-[11px] font-black text-slate-600 i18n" data-zh="OTA" data-en="OTA">OTA</span>
                    </div>
                    <div class="feature-btn" onclick="sendCommand('CMD_TEST_AUDIO')">
                        <i class="ri-volume-up-line text-green-500 text-xl"></i>
                        <span class="text-[11px] font-black text-slate-600 i18n" data-zh="测试" data-en="Test">测试</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 安全标签 -->
        <div class="flex items-center justify-center gap-2 text-[9px] font-black text-slate-400 uppercase tracking-tighter">
            <i class="ri-lock-2-line"></i> <span>AES-128 End-to-End Encryption</span>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    const BLE_SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0"; 
    const BLE_CHAR_UUID    = "abcdef01-1234-5678-1234-56789abcdef0";

    let bleDevice = null;
    let bleCharacteristic = null;

    const dot = document.getElementById('bleStatusDot');
    const statusText = document.getElementById('bleStatusText');
    const btnConnectText = document.getElementById('btnConnectText');
    const btnConnect = document.getElementById('btnConnect');
    const btnSend = document.getElementById('btnSend');
    const extFeatures = document.getElementById('extFeatures');

    function onLangChange() {
        document.querySelectorAll('.i18n-ph').forEach(el => {
            const ph = el.getAttribute('data-' + currentLang + '-ph');
            if(ph) el.placeholder = ph;
        });
        
        // 动态更新网页标题，确保纯文本且无残留标签
        const pageTitle = currentLang === 'zh' ? "设备配网 Pro" : "BLE Config Pro";
        document.title = `${pageTitle} | 618002.xyz`;
        
        updateStatusUI();
    }

    function updateStatusUI() {
        const isConnected = bleDevice && bleDevice.gatt.connected;
        if (!isConnected) {
            statusText.innerText = currentLang === 'zh' ? "未连接" : "Disconnected";
            btnConnectText.innerText = currentLang === 'zh' ? "搜索并连接设备" : "Search & Connect";
            btnConnect.classList.remove('btn-pro-danger');
            btnConnect.classList.add('btn-pro-accent');
            btnSend.disabled = true;
            extFeatures.style.opacity = '0.5';
            extFeatures.style.pointerEvents = 'none';
        } else {
            statusText.innerText = currentLang === 'zh' ? "已连接" : "Connected";
            btnConnectText.innerText = currentLang === 'zh' ? "断开蓝牙连接" : "Disconnect";
            btnConnect.classList.remove('btn-pro-accent');
            btnConnect.classList.add('btn-pro-danger');
            btnSend.disabled = false;
            extFeatures.style.opacity = '1';
            extFeatures.style.pointerEvents = 'auto';
        }
    }

    async function toggleBLE() {
        if (!navigator.bluetooth) return alert('Browser not support BLE');
        if (bleDevice && bleDevice.gatt.connected) {
            bleDevice.gatt.disconnect();
            return;
        }

        try {
            statusText.innerText = currentLang === 'zh' ? "连接中..." : "Connecting...";
            bleDevice = await navigator.bluetooth.requestDevice({
                filters: [{ services: [BLE_SERVICE_UUID] }]
            });

            bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
            document.getElementById('deviceName').innerText = bleDevice.name || "ESP32-DEVICE";
            
            const server = await bleDevice.gatt.connect();
            const service = await server.getPrimaryService(BLE_SERVICE_UUID);
            bleCharacteristic = await service.getCharacteristic(BLE_CHAR_UUID);

            dot.classList.add('connected');
            updateStatusUI();
        } catch (error) {
            // 仅在非用户取消的情况下记录错误
            if (error.name !== 'NotFoundError') {
                console.error("BLE Error:", error);
            }
            updateStatusUI();
        }
    }

    function onDisconnected() {
        dot.classList.remove('connected');
        document.getElementById('deviceName').innerText = "Device Offline";
        bleDevice = null;
        updateStatusUI();
    }

    function addWiFiRow() {
        const container = document.getElementById('wifiListContainer');
        const rows = document.querySelectorAll('.wifi-row');
        if (rows.length >= 3) return;

        const row = document.createElement('div');
        row.className = "wifi-row animate-[fadeIn_0.3s]";
        const ssidPH = currentLang === 'zh' ? '备用网络名称' : 'Backup SSID';
        const pwdPH = currentLang === 'zh' ? '密码' : 'Password';
        const labelText = currentLang === 'zh' ? '备用网络' : 'Backup Network';

        row.innerHTML = `
            <button onclick="removeWiFiRow(this)" class="absolute right-4 top-4 text-slate-300 hover:text-red-500 transition-colors">
                <i class="ri-close-circle-fill text-xl"></i>
            </button>
            <div class="flex flex-col gap-4">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${labelText}</span>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" class="input-pro ssid-input" placeholder="${ssidPH}">
                    <input type="password" class="input-pro pwd-input" placeholder="${pwdPH}">
                </div>
            </div>
        `;
        container.appendChild(row);
        if (document.querySelectorAll('.wifi-row').length >= 3) document.getElementById('btnAddRow').style.display = 'none';
    }

    function removeWiFiRow(btn) {
        btn.closest('.wifi-row').remove();
        document.getElementById('btnAddRow').style.display = 'flex';
    }

    async function collectAndSend() {
        const rows = document.querySelectorAll('.wifi-row');
        const wifiList = [];
        rows.forEach(row => {
            const ssid = row.querySelector('.ssid-input').value.trim();
            const pwd = row.querySelector('.pwd-input').value.trim();
            if (ssid) wifiList.push({ s: ssid, p: pwd });
        });
        if (wifiList.length === 0) return;
        await writeToDevice(JSON.stringify({ cmd: "SAVE_LIST", list: wifiList }));
    }

    async function sendCommand(cmdStr) {
        await writeToDevice(JSON.stringify({ cmd: cmdStr }));
    }

    async function writeToDevice(payload) {
        if (!bleCharacteristic) return;
        const oldHTML = btnSend.innerHTML;
        btnSend.innerHTML = '<i class="ri-loader-4-line animate-spin"></i>';
        try {
            await bleCharacteristic.writeValue(new TextEncoder().encode(payload));
            btnSend.innerHTML = '<i class="ri-check-line text-green-500"></i>';
            setTimeout(() => { btnSend.innerHTML = oldHTML; }, 1500);
        } catch (error) {
            alert(error.message);
            btnSend.innerHTML = oldHTML;
        }
    }

    setTimeout(onLangChange, 100);
</script>
{% endblock %}
